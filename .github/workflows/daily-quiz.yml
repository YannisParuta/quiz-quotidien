name: Generate Daily Quiz Questions

on:
  schedule:
    # S'exÃ©cute tous les jours Ã  minuit (UTC)
    - cron: '0 0 * * *'
  # Permet aussi de lancer manuellement
  workflow_dispatch:

jobs:
  generate-questions:
    runs-on: ubuntu-latest
    
    steps:
      - name: Call Vercel API to generate questions
        run: |
          echo "ðŸ¤– Appel de l'API pour gÃ©nÃ©rer 10 questions..."
          response=$(curl -s -w "\n%{http_code}" https://quiz-quotidien.vercel.app/api/generate-questions)
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "ðŸ“Š RÃ©ponse API: $body"
          
          if [ "$http_code" -ne 200 ]; then
            echo "âŒ Erreur: HTTP $http_code"
            exit 1
          fi
          
          echo "âœ… Questions gÃ©nÃ©rÃ©es avec succÃ¨s"
          echo "â³ Attente de 10 secondes pour que GitHub synchronise..."
          sleep 10
      
      - name: Checkout repository (aprÃ¨s gÃ©nÃ©ration)
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
      
      - name: Increment quiz version in index.html
        run: |
          echo "ðŸ”„ IncrÃ©mentation de la version du quiz..."
          
          # Extraire la version actuelle
          current_version=$(grep -oP 'const QUIZ_VERSION = \K\d+' index.html || echo "1")
          new_version=$((current_version + 1))
          
          echo "Version actuelle: $current_version"
          echo "Nouvelle version: $new_version"
          
          # Remplacer la version dans index.html
          sed -i "s/const QUIZ_VERSION = $current_version;/const QUIZ_VERSION = $new_version;/g" index.html
          
          echo "âœ… Version incrÃ©mentÃ©e Ã  $new_version"
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # VÃ©rifier s'il y a des changements
          if git diff --quiet index.html; then
            echo "âš ï¸ Aucun changement dÃ©tectÃ© dans index.html"
            exit 0
          fi
          
          # Ajouter et commiter
          git add index.html
          git commit -m "ðŸ¤– Auto: IncrÃ©mentation version quiz (v$new_version) - $(date +'%Y-%m-%d')"
          
          # Push avec gestion des conflits
          echo "ðŸ“¤ Push des changements..."
          for i in {1..5}; do
            if git push origin main; then
              echo "âœ… Push rÃ©ussi"
              exit 0
            else
              echo "âš ï¸ Tentative $i Ã©chouÃ©e, pull et retry..."
              git pull --rebase origin main
              sleep 3
            fi
          done
          
          echo "âŒ Impossible de pusher aprÃ¨s 5 tentatives"
          exit 1
      
      - name: Summary
        if: success()
        run: |
          echo "### âœ… GÃ©nÃ©ration quotidienne terminÃ©e" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… 10 nouvelles questions ajoutÃ©es" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Version du quiz incrÃ©mentÃ©e" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Cache utilisateurs sera vidÃ© automatiquement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… Date: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
