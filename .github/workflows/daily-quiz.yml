name: Generate Daily Quiz Questions

on:
  schedule:
    # S'exÃ©cute tous les jours Ã  minuit (UTC)
    - cron: '0 0 * * *'
  # Permet aussi de lancer manuellement
  workflow_dispatch:

jobs:
  generate-questions:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Call Vercel API to generate questions
        run: |
          echo "ðŸ¤– Appel de l'API pour gÃ©nÃ©rer 10 questions..."
          response=$(curl -s -w "\n%{http_code}" https://quiz-quotidien.vercel.app/api/generate-questions)
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "ðŸ“Š RÃ©ponse API: $body"
          
          if [ "$http_code" -ne 200 ]; then
            echo "âŒ Erreur: HTTP $http_code"
            exit 1
          fi
          
          echo "âœ… Questions gÃ©nÃ©rÃ©es avec succÃ¨s"
      
      - name: Increment quiz version in index.html
        run: |
          echo "ðŸ”„ IncrÃ©mentation de la version du quiz..."
          
          # Extraire la version actuelle
          current_version=$(grep -oP 'const QUIZ_VERSION = \K\d+' index.html || echo "1")
          new_version=$((current_version + 1))
          
          echo "Version actuelle: $current_version"
          echo "Nouvelle version: $new_version"
          
          # Remplacer la version dans index.html
          sed -i "s/const QUIZ_VERSION = $current_version;/const QUIZ_VERSION = $new_version;/g" index.html
          
          echo "âœ… Version incrÃ©mentÃ©e Ã  $new_version"
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # VÃ©rifier s'il y a des changements
          if git diff --quiet index.html; then
            echo "Aucun changement Ã  commiter"
          else
            # Pull les derniers changements (questions.json a pu Ãªtre modifiÃ© par l'API)
            git pull --rebase origin main
            
            git add index.html
            git commit -m "ðŸ¤– Auto: IncrÃ©mentation version quiz + nouvelles questions - $(date +'%Y-%m-%d')"
            
            # Push avec retry en cas de conflit
            max_attempts=3
            attempt=1
            until git push origin main || [ $attempt -eq $max_attempts ]; do
              echo "âš ï¸ Push Ã©chouÃ©, tentative $attempt/$max_attempts..."
              git pull --rebase origin main
              attempt=$((attempt + 1))
              sleep 2
            done
            
            if [ $attempt -eq $max_attempts ]; then
              echo "âŒ Impossible de push aprÃ¨s $max_attempts tentatives"
              exit 1
            fi
            
            echo "âœ… Changements poussÃ©s sur GitHub"
          fi
      
      - name: Summary
        run: |
          echo "### âœ… GÃ©nÃ©ration quotidienne terminÃ©e" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- 10 nouvelles questions ajoutÃ©es" >> $GITHUB_STEP_SUMMARY
          echo "- Version du quiz incrÃ©mentÃ©e" >> $GITHUB_STEP_SUMMARY
          echo "- Cache utilisateurs sera vidÃ© automatiquement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Date: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
